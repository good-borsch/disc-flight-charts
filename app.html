<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DiscVault - Disc Golf Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #0f2140;
            --bg-glass: rgba(255, 255, 255, 0.05);
            --border-glass: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.4);
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
        }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-primary);
            min-height: 100vh;
        }
        .phone-frame { max-width: 430px; margin: 0 auto; min-height: 100vh; position: relative; }
        .status-bar { display: flex; justify-content: space-between; padding: 12px 24px; font-size: 14px; font-weight: 600; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 430px; background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(20px); border-top: 1px solid var(--border-glass);
            padding: 12px 20px 28px; display: flex; justify-content: space-around; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; padding: 8px 16px; border-radius: 12px;
            background: transparent; border: none; color: var(--text-muted); transition: color 0.2s;
        }
        .nav-item.active { color: var(--accent-cyan); }
        .nav-label { font-size: 11px; font-weight: 500; }
        .search-container { position: relative; margin: 16px; }
        .search-input {
            width: 100%; padding: 16px 20px 16px 50px; background: var(--bg-glass);
            border: 1px solid var(--border-glass); border-radius: 16px;
            color: var(--text-primary); font-size: 16px; outline: none;
        }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:focus { border-color: var(--accent-cyan); }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .disc-list { padding: 0 16px 120px; display: flex; flex-direction: column; gap: 12px; max-height: calc(100vh - 320px); overflow-y: auto; }
        .disc-card {
            background: var(--bg-glass); border: 1px solid var(--border-glass);
            border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s;
        }
        .disc-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }
        .disc-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .disc-name { font-size: 18px; font-weight: 600; }
        .disc-manufacturer { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        .disc-type-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-putter { background: var(--accent-green); color: #000; }
        .badge-midrange { background: var(--accent-blue); color: #fff; }
        .badge-fairway { background: var(--accent-orange); color: #000; }
        .badge-distance { background: var(--accent-red); color: #fff; }
        .flight-numbers { display: flex; gap: 8px; }
        .flight-number {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 10px; min-width: 48px;
        }
        .flight-value { font-size: 18px; font-weight: 700; color: var(--accent-cyan); }
        .flight-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }
        .bottom-sheet-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
        .bottom-sheet {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
            width: 100%; max-width: 430px; max-height: 85vh;
            background: linear-gradient(180deg, #1a2d4a, #0f2140);
            border-radius: 24px 24px 0 0; z-index: 201; transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
        }
        .bottom-sheet.active { transform: translateX(-50%) translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 12px auto; }
        .sheet-content { padding: 0 20px 40px; overflow-y: auto; max-height: calc(85vh - 40px); }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 24px; font-weight: 700; }
        .sheet-subtitle { font-size: 14px; color: var(--text-secondary); }
        .close-btn {
            width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1);
            border: none; color: var(--text-primary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .close-btn:hover { background: var(--accent-red); }
        .specs-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .spec-item { background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: 12px; padding: 12px; }
        .spec-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .spec-value { font-size: 16px; font-weight: 600; color: var(--accent-cyan); }
        .action-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .action-btn {
            flex: 1; padding: 16px; border-radius: 14px; font-size: 15px; font-weight: 600;
            cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue)); color: #fff; }
        .btn-secondary { background: var(--bg-glass); border: 1px solid var(--border-glass); color: var(--text-primary); }
        .flight-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 300;
            display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .flight-modal.active { opacity: 1; visibility: visible; }
        .flight-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .flight-controls { display: flex; gap: 12px; padding: 0 20px 20px; flex-wrap: wrap; }
        .control-btn {
            padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 500;
            cursor: pointer; border: 1px solid var(--border-glass); background: var(--bg-glass); color: var(--text-secondary);
        }
        .control-btn.active { background: var(--accent-cyan); border-color: var(--accent-cyan); color: #000; }
        .flight-chart-container { flex: 1; padding: 20px; display: flex; align-items: center; justify-content: center; }
        .gap-grid-container { padding: 12px; padding-bottom: 100px; height: calc(100vh - 160px); display: flex; flex-direction: column; }
        .gap-header { text-align: center; margin-bottom: 8px; }
        .gap-title { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
        .gap-subtitle { font-size: 12px; color: var(--text-secondary); }
        .gap-grid-wrapper {
            flex: 1; border-radius: 12px;
            background: var(--bg-glass); border: 1px solid var(--border-glass);
            display: flex; flex-direction: column;
        }
        .gap-grid { display: grid; grid-template-columns: 28px repeat(9, 1fr); grid-template-rows: 24px repeat(14, 1fr); flex: 1; }
        .gap-cell {
            border: 1px solid var(--border-glass);
            display: flex; align-items: center; justify-content: center;
            min-height: 0; min-width: 0;
        }
        .gap-header-cell { background: rgba(255,255,255,0.05); font-size: 9px; font-weight: 600; color: var(--text-secondary); }
        .speed-label { font-size: 9px; font-weight: 600; color: var(--text-muted); }
        .bagged-disc {
            width: 85%; height: 85%; max-width: 32px; max-height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-size: 7px; font-weight: 600; text-align: center; padding: 2px; line-height: 1;
        }
        .bagged-disc:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(6,182,212,0.4); }
        .gap-cell-empty { cursor: pointer; transition: background 0.2s; }
        .gap-cell-empty:hover { background: rgba(6,182,212,0.15); }
        .gap-modal-list { max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
        .import-section { padding: 16px; }
        .import-btn {
            width: 100%; padding: 14px; background: var(--bg-glass);
            border: 2px dashed var(--border-glass); border-radius: 14px;
            color: var(--text-secondary); font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .import-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .filter-tags { display: flex; gap: 8px; padding: 0 16px 16px; overflow-x: auto; }
        .filter-tag {
            padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            white-space: nowrap; cursor: pointer; border: 1px solid var(--border-glass);
            background: var(--bg-glass); color: var(--text-secondary);
        }
        .filter-tag.active { background: var(--accent-cyan); border-color: var(--accent-cyan); color: #000; }
        .page-header { padding: 16px 20px; }
        .page-title { font-size: 28px; font-weight: 700; }
        .page-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-desc { font-size: 14px; color: var(--text-secondary); }
        .bag-count { background: var(--accent-cyan); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; margin-left: 8px; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border-glass); border-radius: 2px; }
        .flight-svg { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const getDiscType = (speed) => {
            if (speed <= 3) return { name: "Putter", class: "badge-putter" };
            if (speed <= 5) return { name: "Midrange", class: "badge-midrange" };
            if (speed <= 9) return { name: "Fairway", class: "badge-fairway" };
            return { name: "Distance", class: "badge-distance" };
        };

        const parseTrajectory = (trajectoryString, throwStyle = 'bh') => {
            try {
                const data = JSON.parse(trajectoryString);
                const xMirror = throwStyle === 'fh' ? -1 : 1;
                return data.map(p => ({ x: p.x * -100 * xMirror, y: p.y }));
            } catch { return []; }
        };

        // Icons
        const SearchIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const DiscIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>;
        const BagIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg>;
        const GridIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>;
        const CloseIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const UploadIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const PlusIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const CheckIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;

        // Flight Chart with tappable tooltips
        const FlightChart = ({ disc, throwStyle, power }) => {
            const [activeTooltip, setActiveTooltip] = useState(null);
            const trajectoryKey = `${throwStyle}${power}`;
            const trajectory = useMemo(() => disc[trajectoryKey] ? parseTrajectory(disc[trajectoryKey], throwStyle) : [], [disc, trajectoryKey, throwStyle]);

            if (!trajectory.length) return <div className="empty-state"><div className="empty-title">No flight data</div></div>;

            const pad = 45, w = 350, h = 480;
            const chartW = w - pad * 2, chartH = h - pad * 2;
            const yMax = 480, xRange = 160;
            const scaleX = x => pad + ((x + xRange) / (xRange * 2)) * chartW;
            const scaleY = y => h - pad - (y / yMax) * chartH;
            const pathD = trajectory.map((p, i) => `${i === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`).join(' ');

            const landing = trajectory[trajectory.length - 1];
            const maxTurnPoint = trajectory.reduce((max, p) => p.x > max.x ? p : max, trajectory[0]);
            const finalDist = Math.round(landing.y);
            const maxTurn = Math.round(maxTurnPoint.x);
            const finalFade = Math.round(landing.x);

            const toggleTooltip = (id) => setActiveTooltip(prev => prev === id ? null : id);

            const Tooltip = ({id, x, y, color, lines, anchor='middle'}) => {
                const isActive = activeTooltip === id;
                const boxW = 70, boxH = 28 + (lines.length-1)*12;
                let bx = anchor === 'left' ? x + 12 : anchor === 'right' ? x - boxW - 12 : x - boxW/2;
                let by = y - boxH - 12;
                bx = Math.max(5, Math.min(w - boxW - 5, bx));
                by = Math.max(5, Math.min(h - boxH - 5, by));
                
                return <g style={{cursor:'pointer'}} onClick={() => toggleTooltip(id)}>
                    <circle cx={x} cy={y} r={isActive ? 10 : 7} fill={color} opacity={isActive ? 1 : 0.9}/>
                    <circle cx={x} cy={y} r={isActive ? 14 : 10} fill="none" stroke={color} strokeWidth="2" opacity="0.3"/>
                    {isActive && <>
                        <rect x={bx} y={by} width={boxW} height={boxH} rx="6" fill="rgba(0,0,0,0.85)" stroke={color} strokeWidth="1.5"/>
                        {lines.map((line, i) => <text key={i} x={bx + boxW/2} y={by + 14 + i*12} fill={i===0 ? color : '#fff'} fontSize={i===0 ? 10 : 9} fontWeight={i===0 ? 600 : 400} textAnchor="middle">{line}</text>)}
                    </>}
                </g>;
            };

            return (
                <svg viewBox={`0 0 ${w} ${h}`} style={{width:'100%',height:'100%'}} onClick={(e) => { if(e.target.tagName === 'svg') setActiveTooltip(null); }}>
                    {/* Grid */}
                    {[0,100,200,300,400].map(y => <g key={y}><line x1={pad} y1={scaleY(y)} x2={w-pad} y2={scaleY(y)} stroke="rgba(255,255,255,0.08)"/><text x={pad-6} y={scaleY(y)+3} fill="rgba(255,255,255,0.35)" fontSize="8" textAnchor="end">{y}</text></g>)}
                    {[-100,-50,0,50,100].map(x => <g key={x}><line x1={scaleX(x)} y1={pad} x2={scaleX(x)} y2={h-pad} stroke="rgba(255,255,255,0.08)"/><text x={scaleX(x)} y={h-pad+12} fill="rgba(255,255,255,0.35)" fontSize="8" textAnchor="middle">{x}</text></g>)}
                    
                    {/* Center line */}
                    <line x1={scaleX(0)} y1={pad} x2={scaleX(0)} y2={h-pad} stroke="rgba(255,255,255,0.15)" strokeDasharray="4,4"/>
                    
                    {/* Flight path */}
                    <path d={pathD} fill="none" stroke="#06b6d4" strokeWidth="3" strokeLinecap="round"/>
                    
                    {/* Distance bar */}
                    <line x1={w-pad+8} y1={scaleY(0)} x2={w-pad+8} y2={scaleY(landing.y)} stroke="#10b981" strokeWidth="3" strokeLinecap="round"/>
                    <text x={w-pad+14} y={scaleY(landing.y/2)} fill="#10b981" fontSize="10" fontWeight="600" dominantBaseline="middle">{finalDist}ft</text>
                    
                    {/* Tappable indicators */}
                    <Tooltip id="release" x={scaleX(0)} y={scaleY(0)} color="#ef4444" lines={['Release','0ft']} />
                    {maxTurn > 5 && <Tooltip id="turn" x={scaleX(maxTurnPoint.x)} y={scaleY(maxTurnPoint.y)} color="#f59e0b" lines={['Max Turn', `${maxTurn}ft right`]} anchor="left"/>}
                    <Tooltip id="landing" x={scaleX(landing.x)} y={scaleY(landing.y)} color="#10b981" lines={['Landing', `${finalDist}ft`, `${finalFade>0?'+':''}${finalFade}ft lat`]} anchor={finalFade < 0 ? 'left' : 'right'}/>
                    
                    {/* Axis label */}
                    <text x={w/2} y={h-3} fill="rgba(255,255,255,0.4)" fontSize="9" textAnchor="middle">‚Üê Fade | Turn ‚Üí</text>
                </svg>
            );
        };

        // Flight Stats Component
        const FlightStats = ({ disc, throwStyle, power }) => {
            const trajectoryKey = `${throwStyle}${power}`;
            const trajectory = useMemo(() => disc[trajectoryKey] ? parseTrajectory(disc[trajectoryKey], throwStyle) : [], [disc, trajectoryKey, throwStyle]);
            
            if (!trajectory.length) return null;
            
            const landing = trajectory[trajectory.length - 1];
            const maxTurnPoint = trajectory.reduce((max, p) => p.x > max.x ? p : max, trajectory[0]);
            const maxFadePoint = trajectory.reduce((min, p) => p.x < min.x ? p : min, trajectory[0]);
            
            const stats = {
                distance: Math.round(landing.y),
                maxTurn: Math.round(maxTurnPoint.x),
                finalPos: Math.round(landing.x),
                maxFade: Math.round(maxFadePoint.x),
            };
            
            const flightPattern = stats.maxTurn > 15 && stats.finalPos < -10 ? 'S-Curve' :
                                  stats.finalPos < -20 ? 'Strong Fade' :
                                  stats.maxTurn > 10 ? 'Turnover' : 'Straight';

            return (
                <div style={{padding:'0 20px 20px',display:'flex',flexDirection:'column',gap:12}}>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
                        <div style={{background:'var(--bg-glass)',borderRadius:10,padding:10,textAlign:'center',border:'1px solid var(--border-glass)'}}>
                            <div style={{fontSize:18,fontWeight:700,color:'#10b981'}}>{stats.distance}</div>
                            <div style={{fontSize:9,color:'var(--text-muted)',textTransform:'uppercase'}}>Distance (ft)</div>
                        </div>
                        <div style={{background:'var(--bg-glass)',borderRadius:10,padding:10,textAlign:'center',border:'1px solid var(--border-glass)'}}>
                            <div style={{fontSize:18,fontWeight:700,color:'#f59e0b'}}>{stats.maxTurn > 0 ? '+' : ''}{stats.maxTurn}</div>
                            <div style={{fontSize:9,color:'var(--text-muted)',textTransform:'uppercase'}}>Max Turn (ft)</div>
                        </div>
                        <div style={{background:'var(--bg-glass)',borderRadius:10,padding:10,textAlign:'center',border:'1px solid var(--border-glass)'}}>
                            <div style={{fontSize:18,fontWeight:700,color:'#8b5cf6'}}>{stats.finalPos > 0 ? '+' : ''}{stats.finalPos}</div>
                            <div style={{fontSize:9,color:'var(--text-muted)',textTransform:'uppercase'}}>Final Pos (ft)</div>
                        </div>
                        <div style={{background:'var(--bg-glass)',borderRadius:10,padding:10,textAlign:'center',border:'1px solid var(--border-glass)'}}>
                            <div style={{fontSize:14,fontWeight:600,color:'var(--accent-cyan)'}}>{flightPattern}</div>
                            <div style={{fontSize:9,color:'var(--text-muted)',textTransform:'uppercase'}}>Pattern</div>
                        </div>
                    </div>
                    <div style={{background:'rgba(6,182,212,0.1)',borderRadius:10,padding:12,border:'1px solid rgba(6,182,212,0.2)'}}>
                        <div style={{fontSize:11,color:'var(--text-secondary)',lineHeight:1.5}}>
                            <span style={{color:'#ef4444'}}>‚óè</span> Release point &nbsp;
                            <span style={{color:'#f59e0b'}}>‚óè</span> Max turn &nbsp;
                            <span style={{color:'#10b981'}}>‚óè</span> Landing zone &nbsp;
                            <span style={{color:'#8b5cf6'}}>‚Äî</span> Lateral drift
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [discs, setDiscs] = useState([]);
            const [baggedDiscs, setBaggedDiscs] = useState(() => JSON.parse(localStorage.getItem('baggedDiscs') || '[]'));
            const [activeTab, setActiveTab] = useState('search');
            const [searchTerm, setSearchTerm] = useState('');
            const [typeFilter, setTypeFilter] = useState('all');
            const [selectedDisc, setSelectedDisc] = useState(null);
            const [showFlightModal, setShowFlightModal] = useState(false);
            const [throwStyle, setThrowStyle] = useState('bh');
            const [power, setPower] = useState('2');
            const [gapCellModal, setGapCellModal] = useState(null); // {speed, stability, col}
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('baggedDiscs', JSON.stringify(baggedDiscs)); }, [baggedDiscs]);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        setDiscs(Array.isArray(data) ? data : []);
                        alert(`Loaded ${data.length} discs!`);
                    } catch { alert('Error parsing JSON'); }
                };
                reader.readAsText(file);
            };

            const filteredDiscs = useMemo(() => discs.filter(d => {
                const matchesSearch = !searchTerm || d.model?.toLowerCase().includes(searchTerm.toLowerCase()) || d.manufacturer?.toLowerCase().includes(searchTerm.toLowerCase());
                const type = getDiscType(d.speed).name.toLowerCase();
                return matchesSearch && (typeFilter === 'all' || type === typeFilter);
            }), [discs, searchTerm, typeFilter]);

            const toggleBag = (disc) => setBaggedDiscs(prev => prev.find(d => d.id === disc.id) ? prev.filter(d => d.id !== disc.id) : [...prev, disc]);
            const isInBag = (id) => baggedDiscs.some(d => d.id === id);

            const gridDiscs = useMemo(() => {
                const grid = {};
                baggedDiscs.forEach(d => {
                    const stab = (d.turn || 0) + (d.fade || 0);
                    const col = Math.max(0, Math.min(8, Math.round(4 - stab)));
                    const row = Math.max(1, Math.min(15, d.speed || 5));
                    const key = `${row}-${col}`;
                    if (!grid[key]) grid[key] = [];
                    grid[key].push(d);
                });
                return grid;
            }, [baggedDiscs]);

            // Find candidate discs for a gap cell based on speed and stability
            const getGapCandidates = useMemo(() => {
                if (!gapCellModal) return [];
                const { speed, stability } = gapCellModal;
                
                // Filter discs matching the speed and stability range
                return discs.filter(d => {
                    // Speed must match exactly
                    if (d.speed !== speed) return false;
                    
                    // Calculate disc stability (turn + fade)
                    const discStab = (d.turn || 0) + (d.fade || 0);
                    
                    // Check if stability is within range for this column
                    // Column 0 = stability 4+, column 8 = stability -4 or less
                    // Each column covers ~1 stability point
                    const stabMin = stability - 0.5;
                    const stabMax = stability + 0.5;
                    
                    return discStab >= stabMin && discStab <= stabMax;
                }).filter(d => !isInBag(d.id)) // Exclude already bagged discs
                .sort((a, b) => a.model.localeCompare(b.model));
            }, [gapCellModal, discs, baggedDiscs]);

            const handleGapCellClick = (speed, col) => {
                // Convert column to stability value (col 0 = +4, col 8 = -4)
                const stability = 4 - col;
                setGapCellModal({ speed, stability, col });
            };

            return (
                <div className="phone-frame">
                    <div className="status-bar"><span>9:41</span><span>‚óè‚óè‚óè‚óè üì∂ üîã</span></div>

                    {activeTab === 'search' && <>
                        <div className="page-header">
                            <div className="page-title">Find Discs</div>
                            <div className="page-subtitle">{discs.length} discs loaded</div>
                        </div>
                        <div className="import-section">
                            <input type="file" ref={fileInputRef} accept=".json" onChange={handleFileUpload} style={{display:'none'}}/>
                            <button className="import-btn" onClick={() => fileInputRef.current?.click()}><UploadIcon/> Import disc_data.json</button>
                        </div>
                        <div className="search-container">
                            <span className="search-icon"><SearchIcon/></span>
                            <input className="search-input" placeholder="Search name or manufacturer..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                        </div>
                        <div className="filter-tags">
                            {['all','putter','midrange','fairway','distance'].map(t => <button key={t} className={`filter-tag ${typeFilter===t?'active':''}`} onClick={() => setTypeFilter(t)}>{t.charAt(0).toUpperCase()+t.slice(1)}</button>)}
                        </div>
                        <div className="disc-list">
                            {!discs.length ? <div className="empty-state"><div className="empty-icon">üìÄ</div><div className="empty-title">No discs loaded</div><div className="empty-desc">Import disc_data.json to start</div></div> :
                             !filteredDiscs.length ? <div className="empty-state"><div className="empty-icon">üîç</div><div className="empty-title">No results</div></div> :
                             filteredDiscs.slice(0,50).map(d => {
                                const dt = getDiscType(d.speed);
                                return <div key={d.id} className="disc-card" onClick={() => setSelectedDisc(d)}>
                                    <div className="disc-card-header"><div><div className="disc-name">{d.model}</div><div className="disc-manufacturer">{d.manufacturer}</div></div><span className={`disc-type-badge ${dt.class}`}>{dt.name}</span></div>
                                    <div className="flight-numbers">
                                        <div className="flight-number"><span className="flight-value">{d.speed}</span><span className="flight-label">Speed</span></div>
                                        <div className="flight-number"><span className="flight-value">{d.glide}</span><span className="flight-label">Glide</span></div>
                                        <div className="flight-number"><span className="flight-value">{d.turn}</span><span className="flight-label">Turn</span></div>
                                        <div className="flight-number"><span className="flight-value">{d.fade}</span><span className="flight-label">Fade</span></div>
                                    </div>
                                </div>;
                             })}
                        </div>
                    </>}

                    {activeTab === 'bag' && <>
                        <div className="page-header"><div className="page-title">My Bag<span className="bag-count">{baggedDiscs.length}</span></div></div>
                        <div className="disc-list">
                            {!baggedDiscs.length ? <div className="empty-state"><div className="empty-icon">üéí</div><div className="empty-title">Bag is empty</div></div> :
                             baggedDiscs.map(d => {
                                const dt = getDiscType(d.speed);
                                return <div key={d.id} className="disc-card" onClick={() => setSelectedDisc(d)}>
                                    <div className="disc-card-header"><div><div className="disc-name">{d.model}</div><div className="disc-manufacturer">{d.manufacturer}</div></div><span className={`disc-type-badge ${dt.class}`}>{dt.name}</span></div>
                                    <div className="flight-numbers">
                                        <div className="flight-number"><span className="flight-value">{d.speed}</span><span className="flight-label">Speed</span></div>
                                        <div className="flight-number"><span className="flight-value">{d.glide}</span><span className="flight-label">Glide</span></div>
                                        <div className="flight-number"><span className="flight-value">{d.turn}</span><span className="flight-label">Turn</span></div>
                                        <div className="flight-number"><span className="flight-value">{d.fade}</span><span className="flight-label">Fade</span></div>
                                    </div>
                                </div>;
                             })}
                        </div>
                    </>}

                    {activeTab === 'gap' && <div className="gap-grid-container">
                        <div className="gap-header"><div className="gap-title">Gap Report</div><div className="gap-subtitle">Speed vs Stability ‚Ä¢ {baggedDiscs.length} discs</div></div>
                        <div className="gap-grid-wrapper">
                            <div className="gap-grid">
                                <div className="gap-cell gap-header-cell"></div>
                                {['4','3','2','1','0','-1','-2','-3','-4'].map(s => <div key={s} className="gap-cell gap-header-cell">{s}</div>)}
                                {Array.from({length:14},(_,i)=>14-i).map(spd => <React.Fragment key={spd}>
                                    <div className="gap-cell gap-header-cell"><span className="speed-label">{spd}</span></div>
                                    {Array.from({length:9},(_,col) => {
                                        const cd = gridDiscs[`${spd}-${col}`] || [];
                                        const isEmpty = cd.length === 0;
                                        return <div key={col} className={`gap-cell ${isEmpty ? 'gap-cell-empty' : ''}`} onClick={() => isEmpty ? handleGapCellClick(spd, col) : setSelectedDisc(cd[0])}>{cd.length>0 && <div className="bagged-disc" title={cd.map(x=>x.model).join(', ')}>{cd.length>1?cd.length:cd[0].model.substring(0,4)}</div>}</div>;
                                    })}
                                </React.Fragment>)}
                            </div>
                        </div>
                        <div style={{marginTop:8,display:'flex',justifyContent:'space-between',padding:'0 4px'}}><span style={{fontSize:10,color:'var(--text-muted)'}}>‚Üê Overstable</span><span style={{fontSize:10,color:'var(--text-muted)'}}>Understable ‚Üí</span></div>
                    </div>}

                    <nav className="bottom-nav">
                        <button className={`nav-item ${activeTab==='search'?'active':''}`} onClick={() => setActiveTab('search')}><DiscIcon/><span className="nav-label">Find</span></button>
                        <button className={`nav-item ${activeTab==='bag'?'active':''}`} onClick={() => setActiveTab('bag')}><BagIcon/><span className="nav-label">Bag</span></button>
                        <button className={`nav-item ${activeTab==='gap'?'active':''}`} onClick={() => setActiveTab('gap')}><GridIcon/><span className="nav-label">Report</span></button>
                    </nav>

                    <div className={`bottom-sheet-overlay ${selectedDisc?'active':''}`} onClick={() => setSelectedDisc(null)}/>
                    <div className={`bottom-sheet ${selectedDisc?'active':''}`}>
                        <div className="sheet-handle"/>
                        {selectedDisc && <div className="sheet-content">
                            <div className="sheet-header"><div><div className="sheet-title">{selectedDisc.model}</div><div className="sheet-subtitle">{selectedDisc.manufacturer}</div></div><button className="close-btn" onClick={() => setSelectedDisc(null)}><CloseIcon/></button></div>
                            <div className="flight-numbers" style={{marginBottom:20}}>
                                <div className="flight-number"><span className="flight-value">{selectedDisc.speed}</span><span className="flight-label">Speed</span></div>
                                <div className="flight-number"><span className="flight-value">{selectedDisc.glide}</span><span className="flight-label">Glide</span></div>
                                <div className="flight-number"><span className="flight-value">{selectedDisc.turn}</span><span className="flight-label">Turn</span></div>
                                <div className="flight-number"><span className="flight-value">{selectedDisc.fade}</span><span className="flight-label">Fade</span></div>
                            </div>
                            <div className="specs-grid">
                                <div className="spec-item"><div className="spec-label">Type</div><div className="spec-value">{getDiscType(selectedDisc.speed).name}</div></div>
                                <div className="spec-item"><div className="spec-label">Stability</div><div className="spec-value">{selectedDisc.stability ?? 'N/A'}</div></div>
                                <div className="spec-item"><div className="spec-label">Diameter</div><div className="spec-value">{selectedDisc.diameter} cm</div></div>
                                <div className="spec-item"><div className="spec-label">Height</div><div className="spec-value">{selectedDisc.height} cm</div></div>
                                <div className="spec-item"><div className="spec-label">Rim Depth</div><div className="spec-value">{selectedDisc.rimdepth} cm</div></div>
                                <div className="spec-item"><div className="spec-label">Rim Width</div><div className="spec-value">{selectedDisc.rimthickness} cm</div></div>
                                <div className="spec-item"><div className="spec-label">Max Weight</div><div className="spec-value">{selectedDisc.maxweight} g</div></div>
                                <div className="spec-item"><div className="spec-label">Approved</div><div className="spec-value">{selectedDisc.dateapproved}</div></div>
                            </div>
                            <div className="action-buttons">
                                <button className="action-btn btn-secondary" onClick={() => toggleBag(selectedDisc)}>{isInBag(selectedDisc.id)?<><CheckIcon/> In Bag</>:<><PlusIcon/> Add</>}</button>
                                <button className="action-btn btn-primary" onClick={() => setShowFlightModal(true)}>Flight Path</button>
                            </div>
                        </div>}
                    </div>

                    <div className={`flight-modal ${showFlightModal?'active':''}`}>
                        <div className="flight-modal-header"><div className="page-title">{selectedDisc?.model}</div><button className="close-btn" onClick={() => setShowFlightModal(false)}><CloseIcon/></button></div>
                        <div className="flight-controls">
                            <div style={{display:'flex',gap:8}}><button className={`control-btn ${throwStyle==='bh'?'active':''}`} onClick={() => setThrowStyle('bh')}>Backhand</button><button className={`control-btn ${throwStyle==='fh'?'active':''}`} onClick={() => setThrowStyle('fh')}>Forehand</button></div>
                            <div style={{display:'flex',gap:8}}><button className={`control-btn ${power==='1'?'active':''}`} onClick={() => setPower('1')}>Slow</button><button className={`control-btn ${power==='2'?'active':''}`} onClick={() => setPower('2')}>Med</button><button className={`control-btn ${power==='3'?'active':''}`} onClick={() => setPower('3')}>Fast</button></div>
                        </div>
                        <div className="flight-chart-container"><div style={{width:'100%',maxWidth:380,aspectRatio:'0.7',background:'var(--bg-glass)',borderRadius:16,padding:10}}>{selectedDisc && <FlightChart disc={selectedDisc} throwStyle={throwStyle} power={power}/>}</div></div>
                        {selectedDisc && <FlightStats disc={selectedDisc} throwStyle={throwStyle} power={power}/>}
                    </div>

                    {/* Gap Candidates Modal */}
                    <div className={`bottom-sheet-overlay ${gapCellModal?'active':''}`} onClick={() => setGapCellModal(null)}/>
                    <div className={`bottom-sheet ${gapCellModal?'active':''}`}>
                        <div className="sheet-handle"/>
                        {gapCellModal && <div className="sheet-content">
                            <div className="sheet-header">
                                <div>
                                    <div className="sheet-title">Fill This Gap</div>
                                    <div className="sheet-subtitle">Speed {gapCellModal.speed} ‚Ä¢ Stability {gapCellModal.stability > 0 ? '+' : ''}{gapCellModal.stability}</div>
                                </div>
                                <button className="close-btn" onClick={() => setGapCellModal(null)}><CloseIcon/></button>
                            </div>
                            
                            <div style={{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap'}}>
                                <div style={{background:'var(--bg-glass)',border:'1px solid var(--border-glass)',borderRadius:10,padding:'8px 12px',flex:1,minWidth:80}}>
                                    <div style={{fontSize:10,color:'var(--text-muted)',textTransform:'uppercase'}}>Speed</div>
                                    <div style={{fontSize:18,fontWeight:700,color:'var(--accent-cyan)'}}>{gapCellModal.speed}</div>
                                </div>
                                <div style={{background:'var(--bg-glass)',border:'1px solid var(--border-glass)',borderRadius:10,padding:'8px 12px',flex:1,minWidth:80}}>
                                    <div style={{fontSize:10,color:'var(--text-muted)',textTransform:'uppercase'}}>Turn + Fade</div>
                                    <div style={{fontSize:18,fontWeight:700,color:'var(--accent-orange)'}}>{gapCellModal.stability > 0 ? '+' : ''}{gapCellModal.stability}</div>
                                </div>
                                <div style={{background:'var(--bg-glass)',border:'1px solid var(--border-glass)',borderRadius:10,padding:'8px 12px',flex:1,minWidth:80}}>
                                    <div style={{fontSize:10,color:'var(--text-muted)',textTransform:'uppercase'}}>Candidates</div>
                                    <div style={{fontSize:18,fontWeight:700,color:'var(--accent-green)'}}>{getGapCandidates.length}</div>
                                </div>
                            </div>
                            
                            {getGapCandidates.length === 0 ? (
                                <div className="empty-state" style={{padding:'30px 20px'}}>
                                    <div className="empty-icon">üîç</div>
                                    <div className="empty-title">No candidates found</div>
                                    <div className="empty-desc">No discs in your database match Speed {gapCellModal.speed} with stability around {gapCellModal.stability}</div>
                                </div>
                            ) : (
                                <div className="gap-modal-list">
                                    {getGapCandidates.slice(0, 20).map(d => {
                                        const dt = getDiscType(d.speed);
                                        const discStab = (d.turn || 0) + (d.fade || 0);
                                        return (
                                            <div key={d.id} className="disc-card" onClick={() => { setGapCellModal(null); setSelectedDisc(d); }}>
                                                <div className="disc-card-header">
                                                    <div>
                                                        <div className="disc-name">{d.model}</div>
                                                        <div className="disc-manufacturer">{d.manufacturer}</div>
                                                    </div>
                                                    <span className={`disc-type-badge ${dt.class}`}>{dt.name}</span>
                                                </div>
                                                <div className="flight-numbers">
                                                    <div className="flight-number"><span className="flight-value">{d.speed}</span><span className="flight-label">Speed</span></div>
                                                    <div className="flight-number"><span className="flight-value">{d.glide}</span><span className="flight-label">Glide</span></div>
                                                    <div className="flight-number"><span className="flight-value">{d.turn}</span><span className="flight-label">Turn</span></div>
                                                    <div className="flight-number"><span className="flight-value">{d.fade}</span><span className="flight-label">Fade</span></div>
                                                    <div className="flight-number" style={{background:'rgba(249,115,22,0.2)',borderColor:'var(--accent-orange)'}}><span className="flight-value" style={{color:'var(--accent-orange)'}}>{discStab > 0 ? '+' : ''}{discStab}</span><span className="flight-label">Stab</span></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {getGapCandidates.length > 20 && <div style={{textAlign:'center',padding:12,color:'var(--text-muted)',fontSize:13}}>+{getGapCandidates.length - 20} more candidates</div>}
                                </div>
                            )}
                        </div>}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App/>, document.getElementById('root'));
    </script>
</body>
</html>